# https://github.com/NobbZ/nixos-config/blob/main/.github/workflows/flake-update.yml

name: "flake-update"

on:
  workflow_dispatch:
  schedule:
  - cron: '00 02 1 * *'

jobs:
  bump_lock:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      name: Clone repository
    - uses: cachix/install-nix-action@v17
      name: Install Nix
      with:
        install_url: https://releases.nixos.org/nix/nix-2.8.0/install
        extra_nix_config: |
          experimental-features = nix-command flakes
          auto-optimise-store = true
          extra-substituters = https://viperml.cachix.org
          extra-trusted-public-keys = viperml.cachix.org-1:qZhKBMTfmcLL+OG6fj/hzsMEedgKvZVFRRAhq7j8Vh8=
          extra-substituters = https://nix-community.cachix.org
          extra-trusted-public-keys = nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
    - run: nix flake update
      name: Update flake
    - name: Upload lockfile
      uses: actions/upload-artifact@v3
      with:
        name: flake_lock
        path: flake.lock

  cache:
    runs-on: ubuntu-latest
    needs: [bump_lock]
    steps:
    - uses: actions/checkout@v3
      name: Clone repository
    - uses: cachix/install-nix-action@v17
      name: Install Nix
      with:
        install_url: https://releases.nixos.org/nix/nix-2.8.0/install
        extra_nix_config: |
          experimental-features = nix-command flakes
          auto-optimise-store = true
          extra-substituters = https://viperml.cachix.org
          extra-trusted-public-keys = viperml.cachix.org-1:qZhKBMTfmcLL+OG6fj/hzsMEedgKvZVFRRAhq7j8Vh8=
          extra-substituters = https://nix-community.cachix.org
          extra-trusted-public-keys = nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
    - name: Set up cachix
      uses: cachix/cachix-action@master
      with:
        name: viperml
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        pathsToPush: result
    - name: Restore lockfile
      uses: actions/download-artifact@v3
      with:
        name: flake_lock
    - run: nix build .#deploy-rs

  check:
    runs-on: ubuntu-latest
    needs: [bump_lock, cache]
    steps:
    - uses: actions/checkout@v3
      name: Clone repository
    - uses: cachix/install-nix-action@v17
      name: Install Nix
      with:
        install_url: https://releases.nixos.org/nix/nix-2.8.0/install
        extra_nix_config: |
          experimental-features = nix-command flakes
          auto-optimise-store = true
          extra-substituters = https://viperml.cachix.org
          extra-trusted-public-keys = viperml.cachix.org-1:qZhKBMTfmcLL+OG6fj/hzsMEedgKvZVFRRAhq7j8Vh8=
          extra-substituters = https://nix-community.cachix.org
          extra-trusted-public-keys = nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
    - name: Restore lockfile
      uses: actions/download-artifact@v3
      with:
        name: flake_lock
    - run: nix build .#nixosConfigurations.cloud.config.system.build.toplevel
    - run: nix flake check

  pr:
    runs-on: ubuntu-latest
    needs: [bump_lock, cache, check]
    steps:
    - uses: actions/checkout@v3
      name: Clone repository
    - name: Restore lockfile
      uses: actions/download-artifact@v3
      with:
        name: flake_lock
    - name: Create Pull request
      uses: peter-evans/create-pull-request@v3
      with:
        token: ${{ secrets.PAT }}
        title: 'chore: periodic version bump'
        commit-message: This commit was autogenerated
        branch: automatic-upgrade
        delete-branch: true
